<%= render 'shared/create_short_link_modal' %>
<%= render partial: "shared/summary_stats", locals: { number_of_visits: @number_of_visits, unique_visits: @unique_visits, number_of_links_shared: @number_of_links_shared, countries_reached: @countries_reached } %>

<div class="row">
  <div class="page-header">
    <h5><%= @team.name %> links list</h5>
  </div>
  <%= render partial: "short_urls/short_urls_table", locals: { short_urls: @short_urls } %>
</div>

<div class="row">
  <div class="page-header">
    <h5><%= @team.name %> overview</h5>
  </div>
  <%= line_chart @team.visits_per_day %>
</div>

<div class="row">
  <div class="page-header">
    <h5>Geographical origin</h5>
  </div>
  <div class="map-buttons">
    <a href="" class="btn btn-primary toggle-map-button">Switch to List view</a>
  </div>
  <div id="map" class="leaflet-container leaflet-fade-anim"></div>
  <div class="visits-by-country-table" style="display:none">
    <%= render partial: "short_urls/visits_by_country_table", locals: { visits_by_country: @top_10_visits_by_country } %>
  </div>
</div>

<div class="row group">
  <div class="col col-6">
    <div class="page-header">
      <h5>Top organisations</h5>
    </div>
    <%= render partial: "short_urls/organizations_table" %>
  </div>

  <div class="col col-6">
    <div class="page-header">
      <h5>Top referrals</h5>
    </div>
    <%= bar_chart @team.top_referrals %>
  </div>
</div>

<script>
    $(document).ready(function() {
      var carto_table = "<%= CARTODB_LAYERS_CONFIG['tables'][Rails.env]['organizations_by_user'] %>";
      var carto_tiles = new cartodb.Tiles({
        user_name: '<%= CARTODB_CONFIG['username'] %>',
        sublayers: [{
          sql: "SELECT * FROM " + carto_table + " WHERE user_id IN (<%= @team.users.map(&:id).join(',') %>);",
          cartocss: "#" + carto_table + "<%= raw CARTODB_LAYERS_CONFIG['css'] %>"
        }]
      });

      var cartoOverlay = null;

      map.on('baselayerchange', function() { cartoOverlay.bringToFront() });
      carto_tiles.getTiles(function(o) {
        cartoOverlay = L.tileLayer(o.tiles[0]).addTo(map)
      });
    });
</script>

